<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <div class="header-info">
        <span class="header-name">Aura</span>
        <span class="header-status">Tu asistente de bienestar</span>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button>
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" #content>
  <div class="messages-container">
    <!-- Agrupar mensajes por día -->
    <div *ngFor="let group of groupedMessages" class="message-date-group">
      <!-- Separador de fecha -->
      <div class="date-separator" *ngIf="group.date">
        <span>{{ group.date }}</span>
      </div>

      <!-- Mensajes del día -->
      <div *ngFor="let cluster of group.clusters" class="message-cluster">
        <div class="message-row" 
             [class.user-row]="cluster.sender === 'user'"
             [class.bot-row]="cluster.sender === 'bot'">
          
          <!-- Avatar (solo en el primer mensaje del cluster) -->
          <ion-avatar *ngIf="cluster.sender === 'bot'" class="message-avatar">
            <img src="assets/icon/bot_aura.png" alt="Aura" />
          </ion-avatar>
          
          <!-- Burbujas del cluster -->
          <div class="bubble-group">
            <div *ngFor="let msg of cluster.messages; let last = last" 
                 class="message-bubble"
                 [class.bubble-first]="msg.isFirst"
                 [class.bubble-last]="last"
                 [class.user-bubble]="cluster.sender === 'user'"
                 [class.bot-bubble]="cluster.sender === 'bot'">
              <p class="message-text">{{ msg.text }}</p>
            </div>
            <!-- Timestamp (solo en el último mensaje) -->
            <span class="message-timestamp">{{ cluster.timestamp }}</span>
          </div>

          <!-- Avatar usuario (invisible pero mantiene espacio) -->
          <div *ngIf="cluster.sender === 'user'" class="message-avatar-spacer"></div>
        </div>
      </div>
    </div>

    <!-- Indicador de escritura -->
    <div *ngIf="botIsTyping" class="typing-indicator-container">
      <div class="message-row bot-row">
        <ion-avatar class="message-avatar">
          <img src="assets/icon/bot_aura.png" alt="Aura" />
        </ion-avatar>
        <div class="typing-bubble">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>

<ion-footer>
  <ion-toolbar class="input-toolbar">
    <div class="input-container">
      <ion-textarea
        [(ngModel)]="newMessage"
        placeholder="¡Escribe tu pregunta aqui!"
        [autoGrow]="true"
        [rows]="1"
        [maxlength]="1000"
        class="message-input"
        (keyup.enter)="handleEnter($event)">
      </ion-textarea>
      
      <ion-button 
        (click)="sendMessage()" 
        [disabled]="!newMessage.trim()"
        class="send-button"
        shape="round"
        fill="clear">
        <ion-icon name="arrow-up-circle" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>