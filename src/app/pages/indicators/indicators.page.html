<!-- src/app/pages/indicators/indicators.page.html -->
<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start" *ngIf="!esConfiguracionInicial">
      <ion-back-button defaultHref="/home" text="" aria-label="Volver al inicio"></ion-back-button>
    </ion-buttons>
    
    <ion-title>
      {{ esConfiguracionInicial ? 'üéØ Configuraci√≥n Inicial' : 'üìä Mis Indicadores' }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  
  <!-- ============================================
       BANNER DE BIENVENIDA (Config Inicial)
       ============================================ -->
  <div *ngIf="esConfiguracionInicial" class="welcome-banner">
    <div class="welcome-content">
      <h1>üëã ¬°Bienvenido a NutPsi!</h1>
      <p>Completa tu perfil para comenzar tu journey de bienestar</p>
    </div>
  </div>

  <!-- ============================================
       MENSAJE DE ERROR GLOBAL
       ============================================ -->
  <div class="error-banner" *ngIf="errorMessage && !loading" role="alert" aria-live="polite">
    <ion-icon name="alert-circle" color="danger" aria-hidden="true"></ion-icon>
    <span>{{ errorMessage }}</span>
  </div>

  <!-- ============================================
       INFO DE √öLTIMOS VALORES (si existen)
       ============================================ -->
  <ion-card *ngIf="ultimosValores.peso && !esConfiguracionInicial" class="info-card">
    <ion-card-content>
      <div class="info-content">
        <!-- ‚úÖ CORREGIDO: trending-up-outline reemplazado por trending-up -->
        <ion-icon name="trending-up" color="primary" aria-hidden="true"></ion-icon>
        <div class="info-text">
          <strong>Datos precargados</strong>
          <p>√öltimo registro: {{ ultimosValores.peso }}kg, {{ ultimosValores.estatura }}cm (IMC: {{ ultimosValores.imc }})</p>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- ============================================
       FORMULARIO PRINCIPAL
       ============================================ -->
  <ion-card class="form-card">
    <ion-card-header>
      <ion-card-title>
        {{ esConfiguracionInicial ? 'Tu Informaci√≥n' : 'Nuevo Registro' }}
      </ion-card-title>
    </ion-card-header>
    
    <ion-card-content>
      <form [formGroup]="indicatorForm" (ngSubmit)="submitIndicator()">
        
        <!-- ============================================
             DATOS F√çSICOS
             ============================================ -->
        <div class="form-section">
          <div class="section-header">
            <!-- ‚úÖ CORREGIDO: scale-outline reemplazado por scale -->
            <ion-icon name="scale" color="primary" aria-hidden="true"></ion-icon>
            <h3>Datos F√≠sicos</h3>
          </div>
          
          <div class="fields-row">
            <!-- Peso -->
            <div class="field-group">
              <ion-item class="form-item" [class.item-has-error]="formControls['peso'].touched && formControls['peso'].errors">
                <ion-label position="stacked">Peso (kg) *</ion-label>
                <ion-input 
                  type="number" 
                  formControlName="peso"
                  placeholder="70"
                  (ionInput)="clearError()"
                  aria-describedby="peso-errors"
                  aria-invalid="{{ formControls['peso'].touched && formControls['peso'].errors ? 'true' : 'false' }}">
                </ion-input>
              </ion-item>
              <ion-note color="danger" id="peso-errors" *ngIf="formControls['peso'].touched && formControls['peso'].errors" role="alert">
                <ion-icon name="alert-circle" aria-hidden="true"></ion-icon>
                <span *ngIf="formControls['peso'].errors?.['required']">Requerido</span>
                <span *ngIf="formControls['peso'].errors?.['min'] || formControls['peso'].errors?.['max']">30-300kg</span>
              </ion-note>
            </div>

            <!-- Estatura -->
            <div class="field-group">
              <ion-item class="form-item" [class.item-has-error]="formControls['estatura'].touched && formControls['estatura'].errors">
                <ion-label position="stacked">Estatura (cm) *</ion-label>
                <ion-input 
                  type="number" 
                  formControlName="estatura"
                  placeholder="170"
                  (ionInput)="clearError()"
                  aria-describedby="estatura-errors"
                  aria-invalid="{{ formControls['estatura'].touched && formControls['estatura'].errors ? 'true' : 'false' }}">
                </ion-input>
              </ion-item>
              <ion-note color="danger" id="estatura-errors" *ngIf="formControls['estatura'].touched && formControls['estatura'].errors" role="alert">
                <ion-icon name="alert-circle" aria-hidden="true"></ion-icon>
                <span *ngIf="formControls['estatura'].errors?.['required']">Requerido</span>
                <span *ngIf="formControls['estatura'].errors?.['min'] || formControls['estatura'].errors?.['max']">100-250cm</span>
              </ion-note>
            </div>
          </div>

          <!-- IMC Preview -->
          <div class="imc-card" *ngIf="formControls['peso'].valid && formControls['estatura'].valid" role="status" aria-live="polite">
            <div class="imc-icon">
              <!-- ‚úÖ CORREGIDO: heart-outline reemplazado por heart -->
              <ion-icon name="heart" [color]="getBMIColor(calculateBMI(formControls['peso'].value, formControls['estatura'].value))" aria-hidden="true"></ion-icon>
            </div>
            <div class="imc-info">
              <span class="imc-label">Tu IMC</span>
              <span class="imc-value" [class]="'imc-' + getBMIColor(calculateBMI(formControls['peso'].value, formControls['estatura'].value))">
                {{ calculateBMI(formControls['peso'].value, formControls['estatura'].value) }}
              </span>
              <span class="imc-category">{{ getBMICategory(calculateBMI(formControls['peso'].value, formControls['estatura'].value)) }}</span>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- ============================================
             ESTADO EMOCIONAL
             ============================================ -->
        <div class="form-section">
          <div class="section-header">
            <!-- ‚úÖ CORREGIDO: happy-outline reemplazado por happy -->
            <ion-icon name="happy" color="primary" aria-hidden="true"></ion-icon>
            <h3>Estado Emocional</h3>
          </div>
          
          <!-- Estado de √°nimo -->
          <ion-item class="form-item" [class.item-has-error]="formControls['estadoAnimo'].touched && formControls['estadoAnimo'].errors">
            <ion-label position="stacked">¬øC√≥mo te sientes hoy? *</ion-label>
            <ion-select 
              formControlName="estadoAnimo" 
              placeholder="Selecciona tu estado"
              interface="action-sheet"
              (ionChange)="clearError()"
              aria-describedby="estadoAnimo-errors"
              aria-invalid="{{ formControls['estadoAnimo'].touched && formControls['estadoAnimo'].errors ? 'true' : 'false' }}">
              <ion-select-option value="excelente">üòä Excelente</ion-select-option>
              <ion-select-option value="bueno">üôÇ Bueno</ion-select-option>
              <ion-select-option value="regular">üòê Regular</ion-select-option>
              <ion-select-option value="malo">üòî Malo</ion-select-option>
              <ion-select-option value="muy-malo">üò¢ Muy Malo</ion-select-option>
            </ion-select>
          </ion-item>
          <ion-note color="danger" id="estadoAnimo-errors" *ngIf="formControls['estadoAnimo'].touched && formControls['estadoAnimo'].errors?.['required']" role="alert">
            <ion-icon name="alert-circle" aria-hidden="true"></ion-icon>
            <span>Selecciona tu estado de √°nimo</span>
          </ion-note>

          <!-- Emociones -->
          <div class="emotions-section">
            <ion-label class="emotions-label">
              Emociones que sientes *
            </ion-label>
            
            <div class="emotions-grid" role="group" aria-labelledby="emociones-label">
              <ion-chip
                *ngFor="let emocion of emocionesDisponibles"
                [class.chip-selected]="isEmocionSelected(emocion.value)"
                [color]="isEmocionSelected(emocion.value) ? 'primary' : 'medium'"
                (click)="toggleEmocion(emocion.value)"
                class="emotion-chip"
                role="checkbox"
                [attr.aria-checked]="isEmocionSelected(emocion.value)"
                [attr.aria-label]="emocion.label">
                <span class="emotion-emoji" aria-hidden="true">{{ emocion.emoji }}</span>
                <ion-label>{{ emocion.label }}</ion-label>
              </ion-chip>
            </div>
            
            <ion-note color="danger" id="emociones-errors" *ngIf="formControls['emociones'].touched && formControls['emociones'].errors?.['required']" role="alert">
              <ion-icon name="alert-circle" aria-hidden="true"></ion-icon>
              <span>Selecciona al menos una emoci√≥n</span>
            </ion-note>
          </div>
        </div>

        

        <!-- ============================================
             NOTAS
             ============================================ -->
        <div class="form-section">
          <div class="section-header">
            <!-- ‚úÖ CORREGIDO: create-outline reemplazado por create -->
            <ion-icon name="create" color="primary" aria-hidden="true"></ion-icon>
            <h3>Notas Adicionales</h3>
          </div>
          
          <ion-item class="form-item textarea-item">
            <ion-label position="stacked">Observaciones</ion-label>
            <ion-textarea 
              formControlName="notas"
              placeholder="¬øC√≥mo te sentiste hoy? ¬øAlgo importante?"
              rows="3"
              [autoGrow]="true"
              aria-label="Observaciones y notas adicionales">
            </ion-textarea>
          </ion-item>
        </div>

        <!-- ============================================
             BOT√ìN SUBMIT
             ============================================ -->
        <ion-button 
          expand="block" 
          type="submit" 
          [disabled]="!indicatorForm.valid || loading"
          class="submit-button"
          [attr.aria-label]="loading ? 'Guardando registro, por favor espere' : (esConfiguracionInicial ? 'Completar perfil' : 'Guardar registro')">
          <ion-spinner *ngIf="loading" name="crescent" aria-hidden="true"></ion-spinner>
          <ion-icon *ngIf="!loading" name="checkmark-circle" slot="start" aria-hidden="true"></ion-icon>
          <span *ngIf="!loading">
            {{ esConfiguracionInicial ? '‚ú® Completar Perfil' : 'üíæ Guardar Registro' }}
          </span>
        </ion-button>

        <p class="required-note">* Campos obligatorios</p>
      </form>
    </ion-card-content>
  </ion-card>

  <!-- ============================================
       HISTORIAL (Solo si NO es config inicial)
       ============================================ -->
  <div *ngIf="!esConfiguracionInicial" class="history-section">
    
    <!-- T√≠tulo de secci√≥n -->
    <div class="history-header">
      <h2>üìà Historial de Registros</h2>
      <ion-chip *ngIf="userIndicators.length > 0" color="primary">
        <ion-label>{{ userIndicators.length }} registros</ion-label>
      </ion-chip>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <ion-spinner name="crescent" color="primary" aria-label="Cargando registros"></ion-spinner>
      <p>Cargando registros...</p>
    </div>

    <!-- Lista de indicadores -->
    <div *ngIf="!loading && userIndicators.length > 0" class="indicators-list">
      <ion-card *ngFor="let indicador of userIndicators" class="indicator-card">
        <ion-card-content>
          <div class="indicator-header">
            <span class="indicator-date">{{ formatDate(indicador.fecha) }}</span>
            <ion-chip [color]="getBMIColor(indicador.imc || 0)" class="imc-badge">
              <ion-label>IMC: {{ indicador.imc }}</ion-label>
            </ion-chip>
          </div>

          <div class="indicator-body">
            <!-- Datos f√≠sicos -->
            <div class="indicator-row">
              <div class="indicator-stat">
                <!-- ‚úÖ CORREGIDO: scale-outline reemplazado por scale -->
                <ion-icon name="scale" color="medium" aria-hidden="true"></ion-icon>
                <div>
                  <span class="stat-label">Peso</span>
                  <span class="stat-value">{{ indicador.peso }} kg</span>
                </div>
              </div>
              
              <div class="indicator-stat">
                <!-- ‚úÖ CORREGIDO: resize-outline reemplazado por resize -->
                <ion-icon name="resize" color="medium" aria-hidden="true"></ion-icon>
                <div>
                  <span class="stat-label">Estatura</span>
                  <span class="stat-value">{{ indicador.estatura }} cm</span>
                </div>
              </div>
            </div>

            <!-- Estado emocional -->
            <div class="indicator-row">
              <div class="indicator-mood">
                <span class="mood-emoji" aria-hidden="true">{{ getMoodEmoji(indicador.estadoAnimo) }}</span>
                <span class="mood-text">{{ indicador.estadoAnimo }}</span>
              </div>
            </div>

            <!-- Emociones -->
            <div class="indicator-emotions" *ngIf="indicador.emociones && indicador.emociones.length > 0">
              <ion-chip *ngFor="let emocion of indicador.emociones" size="small" color="light">
                <ion-label>{{ emocion }}</ion-label>
              </ion-chip>
            </div>

            <!-- Agua y notas -->
            <div class="indicator-extras">
              <div class="water-count" *ngIf="indicador.vasosAgua > 0">
                <!-- ‚úÖ CORREGIDO: water-outline reemplazado por water -->
                <ion-icon name="water" color="primary" aria-hidden="true"></ion-icon>
                <span>{{ indicador.vasosAgua }} vasos</span>
              </div>
            </div>

            <p class="indicator-notes" *ngIf="indicador.notas">
              "{{ indicador.notas }}"
            </p>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Estado vac√≠o -->
    <ion-card *ngIf="!loading && userIndicators.length === 0" class="empty-state">
      <ion-card-content>
        <div class="empty-content">
          <!-- ‚úÖ CORREGIDO: document-outline reemplazado por document -->
          <ion-icon name="document" color="medium" class="empty-icon" aria-hidden="true"></ion-icon>
          <h3>No hay registros a√∫n</h3>
          <p>¬°Agrega tu primer indicador arriba!</p>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

</ion-content>