<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>NutPsi - Iniciar Sesi√≥n</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="login-container">
    
    <!-- Secci√≥n del Logo -->
    <div class="logo-section">
      <div class="logo-container">
        <div class="logo-image">
          <img 
            *ngIf="logoLoaded" 
            src="assets/Nupsi/nupsiLogo.png" 
            alt="NuPsi Logo - Salud nutricional y emocional" 
            class="logo-img" 
            (load)="onLogoLoad()" 
            (error)="onLogoError()">
          <div class="logo-fallback" *ngIf="!logoLoaded" aria-hidden="true">
            <ion-icon name="heart" color="primary" aria-hidden="true"></ion-icon>
            <span>NuPsi</span>
          </div>
        </div>
      </div>
      <h1 class="welcome-title">Bienvenido a NutPsi</h1>
      <p class="subtitle">Tu aliado en salud nutricional y emocional</p>
    </div>

    <!-- Mensaje de Error Global -->
    <div class="error-banner" *ngIf="errorMessage && !isLoggingIn" role="alert" aria-live="polite">
      <ion-icon name="alert-circle" color="danger" aria-hidden="true"></ion-icon>
      <span>{{ errorMessage }}</span>
    </div>

    <!-- ‚úÖ NUEVO: MENSAJE INFORMATIVO PARA APP M√ìVIL -->
    <div *ngIf="isNativeApp" class="info-banner ion-margin-bottom">
      <ion-icon name="information-circle" color="primary" aria-hidden="true"></ion-icon>
      <span>
        <strong>üîí Para mayor seguridad:</strong> Usa email y contrase√±a en la app m√≥vil
      </span>
    </div>

    <!-- Card del Formulario -->
    <div class="form-card">
      <form [formGroup]="loginForm" (ngSubmit)="login()">
        <ion-list lines="none">
          
          <!-- Campo Email -->
          <ion-item class="form-item" [class.item-has-error]="loginForm.get('email')?.invalid && loginForm.get('email')?.touched">
            <ion-label position="stacked" class="input-label">Email</ion-label>
            <ion-input 
              type="email" 
              formControlName="email"
              placeholder="tu@email.com"
              class="custom-input"
              (ionInput)="clearError()"
              required
              aria-describedby="email-errors"
              aria-invalid="{{ loginForm.get('email')?.invalid && loginForm.get('email')?.touched ? 'true' : 'false' }}">
            </ion-input>
            <ion-icon name="mail" slot="start" class="input-icon" aria-hidden="true"></ion-icon>
          </ion-item>
          
          <div class="error-messages" id="email-errors" *ngIf="loginForm.get('email')?.touched && loginForm.get('email')?.errors" role="alert">
            <ion-note color="danger">
              <ion-icon name="alert-circle" aria-hidden="true"></ion-icon>
              <span *ngIf="loginForm.get('email')?.errors?.['required']">Email es requerido</span>
              <span *ngIf="loginForm.get('email')?.errors?.['email']">Formato de email inv√°lido</span>
            </ion-note>
          </div>

          <!-- Campo Contrase√±a -->
          <ion-item class="form-item" [class.item-has-error]="loginForm.get('password')?.invalid && loginForm.get('password')?.touched">
            <ion-label position="stacked" class="input-label">Contrase√±a</ion-label>
            <ion-input 
              [type]="showPassword ? 'text' : 'password'" 
              formControlName="password"
              placeholder="M√≠nimo 6 caracteres"
              class="custom-input"
              (ionInput)="clearError()"
              required
              aria-describedby="password-errors"
              aria-invalid="{{ loginForm.get('password')?.invalid && loginForm.get('password')?.touched ? 'true' : 'false' }}">
            </ion-input>
            <ion-icon name="lock-closed" slot="start" class="input-icon" aria-hidden="true"></ion-icon>
            <ion-button 
              fill="clear" 
              slot="end" 
              (click)="togglePasswordVisibility()"
              class="password-toggle"
              [attr.aria-label]="showPassword ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'"
              [attr.aria-pressed]="showPassword"
              type="button">
              <ion-icon 
                slot="icon-only"
                [name]="showPassword ? 'eye-off' : 'eye'"
                color="medium"
                aria-hidden="true">
              </ion-icon>
            </ion-button>
          </ion-item>
          
          <div class="error-messages" id="password-errors" *ngIf="loginForm.get('password')?.touched && loginForm.get('password')?.errors" role="alert">
            <ion-note color="danger">
              <ion-icon name="alert-circle" aria-hidden="true"></ion-icon>
              <span *ngIf="loginForm.get('password')?.errors?.['required']">Contrase√±a es requerida</span>
              <span *ngIf="loginForm.get('password')?.errors?.['minlength']">M√≠nimo 6 caracteres</span>
            </ion-note>
          </div>
        </ion-list>

        <!-- Bot√≥n de Login con Loading -->
        <ion-button 
          expand="block" 
          type="submit" 
          [disabled]="!loginForm.valid || isLoggingIn"
          class="login-button ion-margin-vertical"
          [attr.aria-label]="isLoggingIn ? 'Iniciando sesi√≥n, por favor espere' : 'Iniciar sesi√≥n'">
          <ion-spinner *ngIf="isLoggingIn" name="crescent" class="button-spinner" aria-hidden="true"></ion-spinner>
          <ion-icon *ngIf="!isLoggingIn" name="log-in" slot="start" aria-hidden="true"></ion-icon>
          <span *ngIf="!isLoggingIn">Iniciar Sesi√≥n</span>
          <span *ngIf="isLoggingIn">Iniciando sesi√≥n...</span>
        </ion-button>
      </form>

      <!-- Separador -->
      <div class="separator" aria-hidden="true">
        <span class="separator-line"></span>
        <span class="separator-text">o continuar con</span>
        <span class="separator-line"></span>
      </div>

      <!-- Bot√≥n Google con Loading -->
      <ion-button 
        expand="block" 
        fill="outline" 
        (click)="loginWithGoogle()"
        [disabled]="isLoggingIn"
        class="google-button ion-margin-vertical"
        [attr.aria-label]="isLoggingIn ? 'Conectando con Google, por favor espere' : 'Continuar con Google'">
        <ion-spinner *ngIf="isLoggingIn" name="crescent" class="button-spinner" aria-hidden="true"></ion-spinner>
        <ion-icon *ngIf="!isLoggingIn" slot="start" name="logo-google" color="danger" aria-hidden="true"></ion-icon>
        <span *ngIf="!isLoggingIn">Continuar con Google</span>
        <span *ngIf="isLoggingIn">Conectando...</span>
      </ion-button>

      <!-- ‚úÖ NUEVO: MENSAJE PARA WEB -->
      <div *ngIf="!isNativeApp" class="web-info ion-margin-top">
        <ion-note color="medium" class="ion-text-center">
          <small>üåê En versi√≥n web: Puedes usar Google Sign-In o email/contrase√±a</small>
        </ion-note>
      </div>
    </div>

    <!-- Enlace a Registro -->
    <div class="register-link">
      <p class="register-text">
        ¬øNo tienes cuenta? 
        <a (click)="goToRegister()" class="register-link-text" role="button" tabindex="0" 
           aria-label="Registrarse en NutPsi">Reg√≠strate aqu√≠</a>
      </p>
    </div>
  </div>
</ion-content>

<!-- ‚úÖ NUEVO: ALERTA PARA GOOGLE SIGN-IN NO DISPONIBLE -->
<ion-alert
  [isOpen]="showGoogleAlert"
  header="Google Sign-In No Disponible"
  [message]="googleAlertMessage"
  [buttons]="['Entendido']"
  (didDismiss)="showGoogleAlert = false">
</ion-alert>