version: "3.1"

rules:

  # ğŸ”¹ Pregunta directa a Gemini (Se mantiene 'ask_gemini' para preguntas directas complejas)
  - rule: Pregunta directa a Gemini
    steps:
      - intent: ask_gemini
      - action: action_call_gemini_chat

  # ğŸ”¹ Fallback automÃ¡tico â†’ Gemini (MODO DINÃMICO: La clave para la IA)
  - rule: Baja confianza â†’ Fallback con Gemini
    steps:
      - intent: nlu_fallback
      - action: action_fallback_to_gemini

  # ğŸ”¹ Out of scope â†’ Gemini (MODO DINÃMICO: Temas fuera del dominio)
  - rule: Tema fuera de alcance â†’ Gemini
    steps:
      - intent: out_of_scope
      - action: action_fallback_to_gemini

  # ğŸŸ¢ NUEVA REGLA: Disparo de la BÃºsqueda de Profesionales
  - rule: BÃºsqueda de Profesionales Cercanos
    steps:
      - intent: ask_for_professional_near
      - action: action_search_nearby_professional
      - action: action_listen

  # ğŸŸ¢ NUEVA REGLA: ExtracciÃ³n y Almacenamiento de RegiÃ³n (Siempre que no estÃ© en un formulario)
  - rule: ExtracciÃ³n de RegiÃ³n
    condition:
      - active_loop: null # No queremos que esto interrumpa la recogida de datos de un formulario
    steps:
      - intent: provide_location # Cuando el usuario da la ubicaciÃ³n
      - slot_was_set:
          - user_region # El NLU extrajo la regiÃ³n de la frase
      - action: action_listen # Escuchar para el siguiente paso (que estarÃ¡ en stories.yml)

  # ğŸŸ¢ NUEVA REGLA DE RECUPERACIÃ“N: Si el usuario da la ubicaciÃ³n justo despuÃ©s de que la acciÃ³n la pidiÃ³
  - rule: Reintentar bÃºsqueda con ubicaciÃ³n proporcionada
    condition:
      - slot_was_set:
          - is_searching_professional: True # El bot estÃ¡ esperando una ubicaciÃ³n
    steps:
      - intent: provide_location # El usuario da la ubicaciÃ³n (y se setea user_region por Slot Filling)
      - action: action_search_nearby_professional # Vuelve a ejecutar la acciÃ³n (ahora con ubicaciÃ³n)
      - action: action_listen


  # ğŸŸ¢ NUEVA REGLA: Bloqueo Ã‰tico de DiagnÃ³stico y RedirecciÃ³n
  - rule: Bloqueo MÃ©dico y Pregunta de Centros
    steps:
      - intent: ask_medical_diagnosis
      - action: action_handle_medical_query
      - action: action_listen 

  # ğŸ”¹ Despedida
  - rule: Despedida amable
    steps:
      - intent: goodbye
      - action: utter_goodbye

  # ğŸ”¹ Respuesta a "Â¿eres un bot?"
  - rule: Responder desafÃ­o bot
    steps:
      - intent: bot_challenge
      - action: utter_iamabot